<script lang="ts">
    import { onMount } from 'svelte'
    import { Button, ColorPicker, Input, Text, TextType } from '@ui'
    import { getRandomWalletColor } from '@core/wallet'
    import { handleError } from '@core/error/handlers/handleError'
    import { localize } from '@core/i18n'
    import { checkActiveProfileAuth } from '@core/profile'
    import { getTrimmedLength } from '@core/utils'
    import { closePopup, updatePopupProps } from '@auxiliary/popup'
    import { validateWalletName, tryCreateAdditionalWallet } from '@core/wallet'

    export let walletAlias = ''
    export let error: string
    export let color = getRandomWalletColor()
    export let isBusy = false
    export let _onMount: (..._: any[]) => Promise<void> = async () => {}

    $: walletAlias, (error = null)
    $: trimmedWalletAlias = walletAlias.trim()

    async function onCreateClick(): Promise<void> {
        try {
            if (!trimmedWalletAlias) {
                return
            }
            isBusy = true
            error = null
            await validateWalletName(trimmedWalletAlias)
            updatePopupProps({ walletAlias, color, error, isBusy })
            await checkActiveProfileAuth(_create, { stronghold: true, ledger: true })
            isBusy = false
        } catch (err) {
            error = err.error
            handleError(err)
            isBusy = false
        }
    }

    function onCancelClick(): void {
        isBusy = false
        closePopup()
    }

    async function _create(): Promise<void> {
        if (trimmedWalletAlias && color) {
            try {
                await tryCreateAdditionalWallet(trimmedWalletAlias, color.toString())
                closePopup()
            } catch (err) {
                isBusy = false
            }
        }
    }

    onMount(async () => {
        isBusy = true
        try {
            await _onMount()
        } catch (err) {
            error = err.error
            handleError(err)
        }
        isBusy = false
    })
</script>

<create-wallet-popup class="flex flex-col h-full justify-between space-y-4">
    <div>
        <title-container class="flex flex-row mb-6">
            <Text type={TextType.h5}>{localize('general.addAWallet')}</Text>
        </title-container>
        <create-wallet-popup-inputs class="w-full flex flex-col justify-between space-y-4">
            <Input
                {error}
                bind:value={walletAlias}
                placeholder={localize('general.walletName')}
                autofocus
                submitHandler={onCreateClick}
                disabled={isBusy}
            />
            <ColorPicker title={localize('general.walletColor')} bind:active={color} isCustomColorEnabled />
        </create-wallet-popup-inputs>
    </div>
    <create-wallet-popup-actions class="flex flex-row justify-between px-2">
        <Button outline classes="-mx-2 w-1/2" onClick={onCancelClick} disabled={isBusy}>
            {localize('actions.cancel')}
        </Button>
        <Button
            disabled={!getTrimmedLength(walletAlias) || isBusy}
            classes="-mx-2 w-1/2"
            onClick={onCreateClick}
            {isBusy}
            busyMessage={localize('general.creating')}
        >
            {localize('actions.create')}
        </Button>
    </create-wallet-popup-actions>
</create-wallet-popup>
