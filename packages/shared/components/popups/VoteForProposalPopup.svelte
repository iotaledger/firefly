<script lang="typescript">
    import { Button, Text, TextHint, FontWeight, TextType, KeyValueBox } from 'shared/components'
    import { HTMLButtonType } from 'shared/components/enums'
    import { selectedAccount, updateSelectedAccount, vote } from '@core/account'
    import { localize } from '@core/i18n'
    import { BASE_TOKEN } from '@core/network'
    import { activeProfile, checkActiveProfileAuth } from '@core/profile'
    import { formatTokenAmountBestMatch } from '@core/wallet/utils'
    import { selectedProposal } from '@contexts/governance/stores'
    import { showAppNotification } from '@auxiliary/notification'
    import { closePopup } from '@auxiliary/popup'

    export let selectedAnswerValues: number[]

    $: formattedVotingPower = formatTokenAmountBestMatch(
        Number($selectedAccount?.votingPower),
        BASE_TOKEN[$activeProfile.networkProtocol]
    )
    $: hasVotingPower = Number($selectedAccount?.votingPower) > 0

    $: isTransferring = $selectedAccount?.isTransferring

    async function handleSubmit(): Promise<void> {
        try {
            await checkActiveProfileAuth(async () => {
                updateSelectedAccount({ isTransferring: true })
                await vote($selectedAccount.index, $selectedProposal?.id, selectedAnswerValues)
                showAppNotification({
                    type: 'success',
                    message: localize('notifications.vote.success'),
                    alert: true,
                })
                closePopup()
                updateSelectedAccount({ isTransferring: false })
            })
        } catch (err) {
            console.error(err)
            updateSelectedAccount({ isTransferring: false })
        }
    }
</script>

<form
    id="vote-proposal"
    on:submit|preventDefault={handleSubmit}
    class="w-full h-full space-y-6 flex flex-auto flex-col flex-shrink-0"
>
    <Text type={TextType.h4} fontWeight={FontWeight.semibold} classes="text-left">
        {localize('popups.voteForProposal.title')}
    </Text>
    <Text type={TextType.p} secondary>
        {localize('popups.voteForProposal.body', {
            values: {
                proposal: $selectedProposal?.title,
            },
        })}
    </Text>
    <div class="space-y-4">
        <KeyValueBox keyText={localize('popups.voteForProposal.key')} valueText={formattedVotingPower} />
        {#if hasVotingPower}
            <TextHint info text={localize('popups.voteForProposal.hint')} />
        {:else}
            <TextHint danger text={localize('popups.voteForProposal.noVotingPower')} />
        {/if}
    </div>
    <popup-buttons class="flex flex-row flex-nowrap w-full space-x-4">
        <Button classes="w-full" outline onClick={closePopup}>{localize('actions.cancel')}</Button>
        <Button
            type={HTMLButtonType.Submit}
            classes="w-full"
            disabled={!hasVotingPower || isTransferring}
            isBusy={isTransferring}
        >
            {localize('actions.vote')}
        </Button>
    </popup-buttons>
</form>
