<script lang="typescript">
    import { AssetIcon, Text, FontWeight, TextType, Tooltip } from 'shared/components'
    import { getNthOccurrenceIndex } from '@core/utils'
    import { IPersistedAsset } from '@core/wallet'
    import { getDecimalSeparator, getGroupSeparator } from '@lib/currency'

    export let asset: IPersistedAsset
    export let unit: string
    const amount: string = '1,000,000,000.918402112321'
    export let fiatAmount: string = ''

    const MAX_LENGTH_PER_LINE = 15

    let displayedAmount: string[] = [amount]
    let tokenAmountElement: HTMLElement = null
    let isTooltipVisible = false

    const hasDecimal = amount.includes(getDecimalSeparator())
    const amountWithoutDecimals = amount.split(getDecimalSeparator())[0]

    $: {
        if (amount.length > MAX_LENGTH_PER_LINE) {
            displayedAmount = breakAmountIntoLines(amount)
        } else {
            displayedAmount = [amount]
        }
    }

    function showTooltip(): void {
        const hasMoreThanTwoDecimalNumbers = hasDecimal && amount.split(getDecimalSeparator())[1].length > 2
        if (amount.length > MAX_LENGTH_PER_LINE && hasDecimal && hasMoreThanTwoDecimalNumbers) {
            isTooltipVisible = true
        }
    }

    function hideTooltip(): void {
        isTooltipVisible = false
    }

    function breakAmountIntoLines(amount: string): string[] {
        const decimals = trimDecimals(amount)
        const thousands = breakThousands(amount, decimals)
        const result: string[] = [...thousands]
        result[result.length - 1] = result[result.length - 1] + decimals
        return result
    }

    function trimDecimals(amount: string): string {
        if (hasDecimal) {
            const TWO_DECIMALS_WITH_SEPARATOR_LENGTH = 3

            const decimalSeparatorIndex = amount.indexOf(getDecimalSeparator())
            const decimalsLength =
                amountWithoutDecimals.length >= MAX_LENGTH_PER_LINE - TWO_DECIMALS_WITH_SEPARATOR_LENGTH
                    ? TWO_DECIMALS_WITH_SEPARATOR_LENGTH
                    : MAX_LENGTH_PER_LINE - amountWithoutDecimals.length

            return amount.slice(decimalSeparatorIndex, decimalSeparatorIndex + decimalsLength)
        } else {
            return ''
        }
    }

    function breakThousands(amount: string, decimals: string = ''): string[] {
        const thousandGroups = amount.split(getGroupSeparator()).length

        if (amount.includes(getGroupSeparator()) && thousandGroups > 3) {
            const lines = Math.ceil((amountWithoutDecimals.length + decimals.length) / MAX_LENGTH_PER_LINE)

            const brokenThousands: string[] = [amountWithoutDecimals]
            for (let index = 0; index < lines - 1; index++) {
                const thousands =
                    index === lines - 1 ? Math.floor(thousandGroups / lines) : Math.ceil(thousandGroups / lines)
                const nthSeparatorIndex = getNthOccurrenceIndex(brokenThousands[index], getGroupSeparator(), thousands)
                brokenThousands[index + 1] = brokenThousands[index].slice(nthSeparatorIndex + 1)
                brokenThousands[index] = brokenThousands[index].slice(0, nthSeparatorIndex + 1)
            }

            return brokenThousands
        } else {
            return [amountWithoutDecimals]
        }
    }
</script>

<amount class="flex flex-col items-center">
    <token-amount
        bind:this={tokenAmountElement}
        class="flex flex-row space-x-3"
        on:mouseenter={showTooltip}
        on:mouseleave={hideTooltip}
    >
        <AssetIcon {asset} />
        <div class="flex flex-col flex-wrap justify-center items-baseline space-x-0.1">
            {#each displayedAmount as line, index}
                <div class="flex items-baseline">
                    <Text type={TextType.h1} fontWeight={FontWeight.semibold}>{line}</Text>
                    {#if unit && index === displayedAmount.length - 1}
                        <Text type={TextType.h4} classes="ml-1" fontWeight={FontWeight.medium}>{unit}</Text>
                    {/if}
                </div>
            {/each}
        </div>
        {#if isTooltipVisible}
            <Tooltip anchor={tokenAmountElement}><Text>{amount} {unit}</Text></Tooltip>
        {/if}
    </token-amount>
    {#if fiatAmount}
        <Text fontSize="md" color="gray-600" darkColor="gray-500">{fiatAmount}</Text>
    {/if}
</amount>
